\makeatletter
\newcommand\resetstackedplots{
\makeatletter
\pgfplots@stacked@isfirstplottrue
\makeatother
\addplot [forget plot,draw=none] coordinates{(Balance-Scale, 1) (Breast-w, 1) (CMC, 1) (Credit-g, 1) (Diabetes, 1) (Tic-Tac-Toe, 1) (Eucalyptus, 1) (PC1, 1) (Jungle-Chess, 1) (Higgs, 1) (Skin, 1) (Traffic, 1) (Walking-Activity, 1)};
}
\makeatother


\begin{tikzpicture}

   \newcommand{\myaddplotcost}[6]{ 

      \addplot+[xshift=#4,fill=#3, draw=black,line width=0.5pt] 
      table[y=token_count_it1, col sep=comma, x=dataset_name_orig, discard if singlconfig={No}{#2}{#1}{#5}{#6}]
      {../archive/SIGMOD2025-Results/CostResults.csv};
      \label{#1_prompt}  

      \addplot+[xshift=#4,fill=none, draw=black,line width=0.5pt, postaction={pattern=crosshatch, pattern color=#3}] 
      table[y=token_count_err_it1, col sep=comma, x=dataset_name_orig, discard if singlconfig={No}{#2}{#1}{#5}{#6}]
      {../archive/SIGMOD2025-Results/CostResults.csv};
      \label{#1_err}  

        
      \addplot+[xshift=#4,fill=#3!50, draw=black,line width=0.5pt] 
      table[y=pp_token_count_it1, col sep=comma, x=dataset_name_orig, discard if singlconfig={No}{#2}{#1}{#5}{#6}]
      {../archive/SIGMOD2025-Results/CostResults.csv};
      \label{#1_pp_prompt}  
        
      \addplot+[xshift=#4,fill=none, draw=black,line width=0.5pt, postaction={pattern=crosshatch, pattern color=#3!50}] 
      table[y=pp_token_count_err_it1, col sep=comma, x=dataset_name_orig, discard if singlconfig={No}{#2}{#1}{#5}{#6}]
      {../archive/SIGMOD2025-Results/CostResults.csv};
      \label{#1_pp_err}  

      \addplot+[xshift=#4,fill=#3!10, draw=black,line width=0.5pt] 
      table[y=fe_token_count_it1, col sep=comma, x=dataset_name_orig, discard if singlconfig={No}{#2}{#1}{#5}{#6}]
      {../archive/SIGMOD2025-Results/CostResults.csv};
      \label{#1_fe_prompt}  

      \addplot+[xshift=#4,fill=none, draw=black,line width=0.5pt, postaction={pattern=crosshatch, pattern color=lightgray}] 
      table[y=fe_token_count_err_it1, col sep=comma, x=dataset_name_orig, discard if singlconfig={No}{#2}{#1}{#5}{#6}]
      {../archive/SIGMOD2025-Results/CostResults.csv};
      \label{#1_fe_err}         
    };

\pgfplotsset{
    discard if singlconfig/.style n args={5}{
        x filter/.code={
            \edef\tempa{\thisrow{has_description}}
            \edef\tempb{#1}
            \ifx\tempa\tempb
              \edef\tempc{\thisrow{llm_model}}
                \edef\tempd{#2}
                  \ifx\tempc\tempd  
                  %
                    \edef\tempe{\thisrow{config}}
                    \edef\tempf{#3}
                    \ifx\tempe\tempf  
                    %
                      \edef\tempg{\thisrow{task}}
                      \edef\temph{#4}
                      \ifx\tempg\temph
                      %
                        \edef\tempi{\thisrow{samples}}
                        \edef\tempj{#5}
                        \ifx\tempi\tempj                                      
                        \else
                        \def\pgfmathresult{inf}
                        \fi
                      %      
                      \else
                      \def\pgfmathresult{inf}
                      \fi
                  %           
                    \else
                    \def\pgfmathresult{inf}
                  \fi
                  %                
                  \else
                  \def\pgfmathresult{inf}
                  \fi
            \else
            \def\pgfmathresult{inf}
            \fi			
        }
    },
};   


\begin{groupplot}[
  group style={
        group name=my fancy plots,
        group size=1 by 2,
        xticklabels at=edge bottom,
        vertical sep=4pt
    }, 
    ybar stacked,
    % ymode=log, 
  ymax=32000,
  y tick label style={/pgf/number format/1000 sep={}},
  x tick label style={/pgf/number format/1000 sep={}},  
  scaled y ticks=false,
  axis line style={black, line width=0.3pt},
  enlarge y limits={0.1,upper},
  enlarge x limits=0.04,
  ylabel={Number of Tokens},
  xlabel={},
  log ticks with fixed point,
  xtick align=outside,
  xtick pos=left,
  ytick pos=left,
  yticklabel style = {font=\Large},
  ylabel style = {font=\Large, yshift=0pt, xshift=20pt},
  height=0.4\columnwidth,
  width=2\columnwidth,
  ymajorgrids=true,
  grid style=dotted,
  minor grid style={gray!70},
  nodes near coords,
  every node near coord/.append style={font=\fontsize{0.1pt}{0.1}, rotate=90, xshift=8pt, yshift=0pt},
  every axis plot/.append style={line width=0.8pt,mark options={scale=1.5,solid}},  
  xticklabel style = {font=\Large, xshift=-6pt, yshift=16pt, rotate=0, anchor=north east},
  legend image post style={line width=.5pt}, 
  log origin y=infty,  
  max space between ticks=5  
]

% \nextgroupplot[bar width=8.5pt,   
%               ymin=1,  
%               ybar stacked,
%               ytick={0,10000,20000,30000},
%               yticklabels={0, 10k, 20k, 30k},            
%               every x tick/.style={ thick,gray, xshift=-6pt,yshift=1.5pt},
%               xtick = data,
%               symbolic x coords={Balance-Scale,Breast-w,CMC,Credit-g,Diabetes,Tic-Tac-Toe,Eucalyptus,PC1,Jungle-Chess,Higgs,Skin,Traffic,Walking-Activity,Black-Friday,Bike-Sharing,House-Sales,NYC,Airlines-DepDelay},
%               legend image code/.code={\draw [#1] (0cm,-0.1cm) rectangle (0.25cm,0.1cm); }, 
%               xticklabel style = {font=\Large, xshift=0pt, yshift=-10pt, rotate=35, anchor=north east},
%               xticklabels={},
%                ylabel={},
%                xtick style={draw=none},] 
              

% \myaddplotcost{CatDBChain}{llama3-70b-8192}{tugb}{-11.5pt}{classification}{0};
% \resetstackedplots
% \myaddplotcost{CatDB}{llama3-70b-8192}{tug}{-20pt}{classification}{0};
% \resetstackedplots
% \myaddplotcost{CAAFETabPFN}{llama3-70b-8192}{color3}{-3pt}{classification}{0};
% \resetstackedplots
% \myaddplotcost{CAAFERandomForest}{llama3-70b-8192}{color4}{5.5pt}{classification}{0};

%  %\node [draw=none,inner sep=0, font=\Large, anchor=west] (leg1) at (rel axis cs: 0.85,0.8) {Llama3-70b-8192};

%  \node [draw=none,inner sep=0, font=\large, anchor=west] (l1) at (rel axis cs: 0.03,0.64) {\shortstack[r]{
%   CatDB \\ 
%   CatDB Chain \\ \\ \\ \\ \\ \\ 
%   CAAFE}};

%   \node [draw=none,inner sep=0, font=\large, anchor=west] (leg2) at (rel axis cs: 0.12,0.64) {\shortstack[l]{
%     \ref{CatDB_prompt} Main Prompt \\ 
%     \ref{CatDBChain_prompt} Main Prompt \\ \\ \\ \\ \\ \\
%     \ref{CAAFETabPFN_prompt} TabPFN Prompt}
%   };

%   \node [draw=none,inner sep=0, font=\large, anchor=west] (leg2) at (rel axis cs: 0.24,0.64) {\shortstack[l]{
%     \ref{CatDB_err} Error \\ \\
%     \ref{CatDBChain_err} Error \\ \\ \\ \\ \\ \\
%     \ref{CAAFERandomForest_prompt} RandomForest Prompt}
%   };

%   \node [draw=none,inner sep=0, font=\large, anchor=west] (leg2) at (rel axis cs: 0.30,0.64) {\shortstack[l]{   
%     \ref{CatDBChain_pp_prompt} PP Prompt \ \ \ \ \ref{CatDBChain_pp_err} PP Error \\  \ref{CatDBChain_fe_prompt} FE Prompt \ \ \ \ \ref{CatDBChain_fe_err} FE Error}
%   };

%
 \nextgroupplot[bar width=8.5pt,   
    ymin=1,                
    ytick={1,10000,20000,30000},
    yticklabels={0, 10k, 20k, 30k},               
    every x tick/.style={ thick,gray, xshift=-6pt,yshift=1.5pt},
    xtick = data,
    symbolic x coords={Balance-Scale,Breast-w,CMC,Credit-g,Diabetes,Tic-Tac-Toe,Eucalyptus,PC1,Jungle-Chess,Higgs,Skin,Traffic,Walking-Activity,Black-Friday,Bike-Sharing,House-Sales,NYC,Airlines-DepDelay},
    legend image code/.code={\draw [#1] (0cm,-0.1cm) rectangle (0.25cm,0.1cm); }, 
    xticklabel style = {font=\Large, xshift=0pt, yshift=-10pt, rotate=25, anchor=north east},] 
              

\myaddplotcost{CatDBChain}{gemini-1.5-pro-latest}{tugb}{-11.5pt}{classification}{0};
\resetstackedplots
\myaddplotcost{CatDB}{gemini-1.5-pro-latest}{tug}{-20pt}{classification}{0};
\resetstackedplots
\myaddplotcost{CAAFERandomForest}{gemini-1.5-pro-latest}{color4}{-3pt}{classification}{0};
\resetstackedplots
\myaddplotcost{CAAFETabPFN}{gemini-1.5-pro-latest}{color3}{5.5pt}{classification}{0};


 %\node [draw=none,inner sep=0, font=\Large, anchor=west] (leg1) at (rel axis cs: 0.85,0.8) {Gemini-1.5-pro};

%  \node [draw=none,inner sep=0, font=\large, anchor=west] (l1) at (rel axis cs: 0.03,0.68) {\shortstack[r]{
%   CatDB \\ \\
%   CatDB Chain \\ \\
%   CAAFE}};

  % \node [draw=none,inner sep=0, font=\large, anchor=west] (leg2) at (rel axis cs: 0.12,0.68) {\shortstack[l]{
  %   \ref{CatDB_prompt} Main Prompt \\ 
  %   \ref{CatDBChain_prompt} Main Prompt \\ 
  %   \ref{CAAFETabPFN_prompt} TabPFN Prompt}
  % };

  % \node [draw=none,inner sep=0, font=\large, anchor=west] (leg2) at (rel axis cs: 0.24,0.68) {\shortstack[l]{
  %   \ref{CatDB_err} Error \\ \\
  %   \ref{CatDBChain_err} Error \\ \\
  %   \ref{CAAFERandomForest_prompt} RandomForest Prompt}
  % };

  % \node [draw=none,inner sep=0, font=\large, anchor=west] (leg2) at (rel axis cs: 0.30,0.68) {\shortstack[l]{   
  %   \ref{CatDBChain_pp_prompt} PP Prompt \ \ \ \ \ref{CatDBChain_pp_err} PP Error \ \ \ \ \ref{CatDBChain_fe_prompt} FE Prompt \ \ \ \ \ref{CatDBChain_fe_err} FE Error}
  % };


\end{groupplot}%

\end{tikzpicture}