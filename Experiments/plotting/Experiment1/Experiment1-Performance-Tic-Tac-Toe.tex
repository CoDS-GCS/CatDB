\pgfmathdeclarefunction{fpumod}{2}{%
        \pgfmathfloatdivide{#1}{#2}%
        \pgfmathfloatint{\pgfmathresult}%
        \pgfmathfloatmultiply{\pgfmathresult}{#2}%
        \pgfmathfloatsubtract{#1}{\pgfmathresult}%
        % replaced `0' by `5' to make it work for this problem
        \pgfmathfloatifapproxequalrel{\pgfmathresult}{#2}{\def\pgfmathresult{5}}{}%
}

\newcommand{\myaddplot}[6]{
  \addplot[xshift=0pt,boxplot,fill=#4, draw=#4, mark options={scale=0.5, fill=#4}, line width=1.5pt] 
  table[y=#2, col sep=comma, x=ID]{#3};
  \label{#5_#6_#1}    
};
    
\newcommand{\addboxplot}[6]{
  \myaddplot{train}{train_auc}{../archive/SIGMOD2025-Results/seperate/#1-#2-#3#4-No.csv}{#5}{#3}{#1};
  \myaddplot{test}{test_auc}{../archive/SIGMOD2025-Results/seperate/#1-#2-#3#4-No.csv}{#6}{#3}{#1};
};

\newcommand{\myaddplotcost}[4]{ %postaction={pattern=horizontal lines, pattern color=#3}
  \addplot[xshift=#4,fill=#3, draw=black,line width=0.3pt] table[x=config, col sep=comma, y=tokens_count, discard if singlconfig={#1}{#2}]{../archive/SIGMOD2025-Results/CostResults.csv};
  \label{#2}    
};

\newcommand{\addcost}[4]{
  \myaddplotcost{#1}{#2}{#3}{#4};
};


\pgfplotsset{
    discard if singlconfig/.style n args={2}{
        x filter/.code={
            \edef\tempa{\thisrow{dataset_name_orig}}
            \edef\tempb{#1}
            \ifx\tempa\tempb
              \edef\tempc{\thisrow{llm_model}}
                \edef\tempd{#2}
                  \ifx\tempc\tempd                  
                  \else
                  \def\pgfmathresult{inf}
                  \fi
            \else
            \def\pgfmathresult{inf}
            \fi			
        }
    },
};

\begin{tikzpicture}[
  every axis/.style={
  height=0.55\columnwidth,
  width=1.1\columnwidth,  
  }]
 \begin{axis}[   
  axis y line*=left,	
  every major tick/.append style={ thick,major tick length=2.5pt, gray},
  axis line style={black},
  ybar,        
  ybar=0pt,
  ymin=0,
  ymax=1,
  log ticks with fixed point,
  y tick label style={/pgf/number format/1000 sep={}},
  x tick label style={/pgf/number format/1000 sep={}},
  scaled y ticks=false,
  enlarge y limits={0.03,upper},
  enlarge x limits=0.005,
  ylabel={AUC $\%$},
  xlabel={},
  ytick={0,0.2,0.4,0.6,0.8,1.0},
  yticklabels={0, 20, 40, 60, 80, 100},
  xtick style={draw=none},
  xtick pos=left,
  ytick pos=left,
  yticklabel style = {font=\large},
  ylabel style = {font=\large, yshift=-5pt},
  xticklabel style = {font=\normalsize, xshift=0pt, yshift=0pt, rotate=0},
  ymajorgrids,
  grid style=dotted,
  minor grid style={gray!80, dotted},
  nodes near coords,
  every node near coord/.style={font=\fontsize{0.1pt}{0.1}, rotate=0},
  every axis plot/.append style={line width=0.8pt,mark options={scale=1.5,solid}},  
  legend image post style={line width=.5pt},   
  boxplot/draw direction=y,
  boxplot={
      draw position={1 + floor(\plotnumofactualtype/24)+ 1/1*fpumod(\plotnumofactualtype,24)},
      box extend=0.85,
  },
  xtick={3,9,15,22},
  xticklabels={CatDB,\shortstack[c]{CatDB\\Chain},\shortstack[c]{CAAFE\\TabPFN},\shortstack[c]{CAAFE\\RandomForest}},
  legend image code/.code={\draw [#1] (0cm,-0.1cm) rectangle (0.2cm,0.1cm); },  
%}
]  
  \addboxplot{CatDB}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{}{white}{white}; %{color4!60}{color4}
  \addboxplot{CatDB}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{}{tug!50}{tug};
  \addboxplot{CatDB}{Tic-Tac-Toe-rnc}{llama3-70b-8192}{}{tugb}{tugb!150};
  

  \addboxplot{CatDBChain}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{}{white}{white};
  \addboxplot{CatDBChain}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{}{tug!50}{tug};
  \addboxplot{CatDBChain}{Tic-Tac-Toe-rnc}{llama3-70b-8192}{}{tugb}{tugb!150};
  

  \addboxplot{CAAFE}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{-TabPFN}{white}{white};
  \addboxplot{CAAFE}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{-TabPFN}{tug!50}{tug};
  \addboxplot{CAAFE}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{-TabPFN}{white}{white};
  
  \addboxplot{CAAFE}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{-RandomForest}{white}{white};
  \addboxplot{CAAFE}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{-RandomForest}{tug!50}{tug};
  \addboxplot{CAAFE}{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{-RandomForest}{white}{white};
  

  \draw[black!50, thick] (59,0) -- (59,103);
  \draw[black!50, thick] (119,0) -- (119,103);
  \draw[black!50, thick] (179,0) -- (179,103);

\end{axis}

\begin{axis}[
  axis y line*=right,
  axis x line=none,  
  ybar,  
  ymin=0.5,
  y tick label style={/pgf/number format/1000 sep={}},
  x tick label style={/pgf/number format/1000 sep={}},
  scaled y ticks=false,
  enlarge y limits={1.3,upper},
  enlarge x limits=0.18,
  ylabel={},
  xlabel={},
  ytick={},
  yticklabels={},
  ytick style={draw=none},
  ytick align=outside,
  nodes near coords,
  nodes near coords align={vertical},
  every node near coord/.append style={font=\fontsize{7.5pt}{0.1}, rotate=90, xshift=-11pt, yshift=-6pt},%, rotate=90, xshift=-10pt, yshift=-5pt
  every axis plot/.append style={line width=0.8pt,mark options={scale=1.5,solid}},  
  legend image post style={line width=.5pt},   
  boxplot/draw direction=y,
  bar width=13pt,
  xtick = data,
  symbolic x coords={CatDB,CatDBChain, CAAFETabPFN,CAAFERandomForest},
  legend image code/.code={\draw [#1] (0cm,-0.1cm) rectangle (0.2cm,0.1cm); }, 
  ]   

    %\addcost{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{color8!10}{0pt};
    \addcost{Tic-Tac-Toe-rnc}{gemini-1.5-pro-latest}{color8!40}{0pt};
    \addcost{Tic-Tac-Toe-rnc}{llama3-70b-8192}{color8!70!}{0pt};
    
\end{axis}

\node [draw=none,inner sep=0, font=\small, anchor=west] (leg1) at (rel axis cs: 0.25,1.15) {\shortstack[r]{
  Gemini-1.5-pro ( \ref{gemini-1.5-pro-latest_CatDB_train} Train \ref{gemini-1.5-pro-latest_CatDB_test} Test \ \ \ \ref{gemini-1.5-pro-latest} Tokens) \\
  Llama3-70b ( \ref{llama3-70b-8192_CatDB_train} Train \ref{llama3-70b-8192_CatDB_test} Test \ \ \ \ref{llama3-70b-8192} Tokens)}};

\end{tikzpicture}